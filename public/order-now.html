<section id="orderNow" class="py-5">
    <div class="container">
        <h2 class="text-center mb-4"><i class="bi bi-cart-check"></i> Order Now</h2>
        <!-- Nav Tabs -->
        <ul class="nav nav-tabs justify-content-center" id="orderTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="viber-tab" data-bs-toggle="tab" data-bs-target="#viber" type="button" role="tab">
                    <i class="fa-brands fa-viber"></i> Viber
                </button>
            </li>
        </ul>
        <!-- Tab Content -->
        <div class="tab-content mt-4">
            <!-- Viber Form -->
            <div class="tab-pane fade show active" id="viber" role="tabpanel">
                <form id="viberForm">
                    <div class="mb-3">
                        <label class="form-label">အမည်</label>
                        <input type="text" class="form-control" id="vbName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">လိပ်စာ</label>
                        <input type="text" class="form-control" id="vbAddress" required>
                    </div>
                    <div class="mb-3">
                        <label for="vbYgnTwsp" class="form-label">မြို့နယ်</label>
                        <select class="form-select" id="vbYgnTwsp" required>
                            <option value="" selected disabled>မြို့နယ်ကို ရွေးချယ်ပါ</option>
                            <option value="တောင်ဥက္ကလာပ" selected>တောင်ဥက္ကလာပ</option>
                            <option value="မြောက်ဒဂုံ">မြောက်ဒဂုံ</option>
                            <option value="ရန်ကင်း">ရန်ကင်း</option>
                            <option value="သင်္ဃန်းကျွန်း">သင်္ဃန်းကျွန်း</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="vbPhone" class="form-label">ဖုန်းနံပါတ်</label>
                        <input type="tel" class="form-control" id="vbPhone" placeholder="09xxxxxxxxx" required>
                    </div>
                    <div class="mb-3">
                        <label for="vbPhone" class="form-label">Order ယူရန်</label>
                        <div class="input-group">
                            <!-- Label styled like input -->
                            <div class="input-group-text d-flex flex-column flex-grow-1 align-items-start">
                                <span>ဆေးဖက်ဝင် ကြက်ပေါင်း</span>
                                <span class="badge text-bg-secondary mt-1">Ks 14,000</span>
                            </div>
                            <!-- Counter (compact width on right) -->
                            <button type="button" class="btn btn-outline-secondary" onclick="decreaseQty('hsc')">-</button>
                            <input type="text" class="form-control text-center" id="vbHsc" value="0" style="max-width: 50px;">
                            <button type="button" class="btn btn-outline-secondary" onclick="increaseQty('hsc')">+</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <!-- Label styled like input -->
                            <div class="input-group-text d-flex flex-column flex-grow-1 align-items-start">
                                <span>ကြက်ပဲငံပြာရည်</span>
                                <span class="badge text-bg-secondary mt-1">Ks 14,000</span>
                            </div>
                            <!-- Counter (compact width on right) -->
                            <button type="button" class="btn btn-outline-secondary" onclick="decreaseQty('ssc')">-</button>
                            <input type="text" class="form-control text-center" id="vbSsc" value="0" style="max-width: 50px;">
                            <button type="button" class="btn btn-outline-secondary" onclick="increaseQty('ssc')">+</button>
                        </div>
                    </div>
                    <div class="mb-3" style="display: none;">
                        <div class="input-group">
                            <!-- Label styled like input -->
                            <div class="input-group-text d-flex flex-column flex-grow-1 align-items-start">
                                <span>နံရိုးပေါင်း စွပ်ပြုပ်</span>
                                <span class="badge text-bg-secondary mt-1">Ks 16,000</span>
                            </div>
                            <!-- Counter (compact width on right) -->
                            <button type="button" class="btn btn-outline-secondary" onclick="decreaseQty('bkt')">-</button>
                            <input type="text" class="form-control text-center" id="vbBkt" value="0" style="max-width: 50px;">
                            <button type="button" class="btn btn-outline-secondary" onclick="increaseQty('bkt')">+</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <!-- Label styled like input -->
                            <div class="input-group-text d-flex flex-column flex-grow-1 align-items-start">
                                <span>ပါမုန့် ယိုသုတ်</span>
                                <span class="badge text-bg-secondary mt-1">Ks 2,500</span>
                            </div>
                            <!-- Counter (compact width on right) -->
                            <button type="button" class="btn btn-outline-secondary" onclick="decreaseQty('pkt')">-</button>
                            <input type="text" class="form-control text-center" id="vbPkt" value="0" style="max-width: 50px;">
                            <button type="button" class="btn btn-outline-secondary" onclick="increaseQty('pkt')">+</button>
                        </div>
                    </div>
                    <!-- Pickup Time -->
                    <div class="mb-3">
                        <label for="pickupTime" class="form-label">Deli အချိန်</label>
                        <select class="form-select" id="vbPickupTime" required></select>
                    </div>
                    <!-- Special Request -->
                    <div class="mb-3">
                        <label class="form-label">အထူးမှတ်ချက်</label>
                        <textarea class="form-control" id="vbRequest" rows="2"></textarea>
                    </div>
                    <button type="button" class="btn btn-success w-100" onclick="previewOrder('viber')">
                        Preview Order & Send via Viber
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Summary Modal -->
<div class="modal fade" id="orderPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderSummary"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmOrderBtn">Confirm & Send</button>
            </div>
        </div>
    </div>
</div>

<script>
// Quantity controls
function increaseQty(item) {
    const input = document.getElementById(
        item === 'hsc' ? 'vbHsc' :
        item === 'ssc' ? 'vbSsc' :
        item === 'bkt' ? 'vbBkt' :
        'vbPkt'
    );
    input.value = parseInt(input.value) + 1;
}

function decreaseQty(item) {
    const input = document.getElementById(
        item === 'hsc' ? 'vbHsc' :
        item === 'ssc' ? 'vbSsc' :
        item === 'bkt' ? 'vbBkt' :
        'vbPkt'
    );
    if (parseInt(input.value) > 0) input.value = parseInt(input.value) - 1;
}

// Preview Order
function previewOrder() {
    let name = document.getElementById('vbName').value;
    let address = document.getElementById('vbAddress').value;
    let ygnTwsp = document.getElementById('vbYgnTwsp').value;
    let phone = document.getElementById('vbPhone').value;
    let hsc = document.getElementById('vbHsc').value;
    let ssc = document.getElementById('vbSsc').value;
    let bkt = document.getElementById('vbBkt').value;
    let pkt = document.getElementById('vbPkt').value;
    let pickup = document.getElementById('vbPickupTime').value;
    let request = document.getElementById('vbRequest').value;


    // Validation - General
    if (
        !name ||
        !address ||
        !ygnTwsp ||
        !phone ||
        (hsc === 0 && ssc === 0 && bkt === 0 && pkt === 0) ||
        !pickup
    ) {
        alert("ကျေးဇူးပြု၍ လိုအပ်သောအချက်အလက်များကို ဖြည့်စွက်ပါ။");
        return;
    }

    // Validation - Myanmar phone number
    const regex = /^09\d{7,9}$/;
    if (!regex.test(phone)) {
        alert("09 မှစတင်၍ မှန်ကန်တဲ့ မြန်မာဖုန်းနံပါတ်ကိုထည့်ပါ။");
        return;
    }

    let summary = `
                <p><strong>အမည် = </strong> ${name}</p>
                <p><strong>လိပ်စာ = </strong> ${address}</p>
                <p><strong>မြို့နယ် = </strong> ${ygnTwsp}</p>
                <p><strong>ဖုန်းနံပါတ် = </strong> ${phone}</p>
                <p><strong>Order ယူရန် = </strong></p>
                <ul>
                ${hsc > 0 ? `<li>ဆေးဖက်ဝင် ကြက်ပေါင်း x ${hsc}</li>` : ""}
                ${ssc > 0 ? `<li>ကြက်ပဲငံပြာရည် x ${ssc}</li>` : ""}
                ${bkt > 0 ? `<li>နံရိုးပေါင်း စွပ်ပြုပ် x ${bkt}</li>` : ""}
                ${pkt > 0 ? `<li>ပါမုန့် ယိုသုတ် x ${pkt}</li>` : ""}
                </ul>
                <p><strong>Deli အချိန် = </strong> ${pickup}</p>
                <p><strong>အထူးမှတ်ချက် = </strong> ${request}</p>
                `;

    document.getElementById("orderSummary").innerHTML = summary;

    // Open modal
    var myModal = new bootstrap.Modal(document.getElementById('orderPreviewModal'));
    myModal.show();

    // Confirm & Send button
    document.getElementById("confirmOrderBtn").onclick = function() {
        let message = `Order Summary\n============\nအမည် = ${name}\nလိပ်စာ = ${address}\nမြို့နယ် = ${ygnTwsp}\nဖုန်းနံပါတ် = ${phone}\n\nOrder ယူရန်\n`;
        if (hsc > 0) message += `- ဆေးဖက်ဝင် ကြက်ပေါင်း x ${hsc}\n`;
        if (ssc > 0) message += `- ကြက်ပဲငံပြာရည် x ${ssc}\n`;
        if (bkt > 0) message += `- နံရိုးပေါင်း စွပ်ပြုပ် x ${bkt}\n`;
        if (pkt > 0) message += `- ပါမုန့် ယိုသုတ် x ${pkt}\n`;
        message += `\nDeli အချိန် = ${pickup}`;

        // Add special request only if not empty or whitespace
        if (request && request.trim() !== "") {
            message += `\nအထူးမှတ်ချက် = ${request}`;
        }

        let url = "viber://forward?text=" + encodeURIComponent(message);
        window.open(url, "_blank");
    }
}

// Pickup slot logic
// =================
// - Daily ordering hours → 9:30–17:30 (MMT).
// - Pickup slots → Morning (11:00–13:00) and Evening (15:30–17:30).
// - Closed days → e.g. Mon/Wed.
// - Selection rules →
//     - Before 12:00 → today’s evening + tomorrow’s morning + tomorrow’s evening (if open).
//     - After 12:00 → tomorrow morning + tomorrow evening (if open).
// - Fallback → If tomorrow is closed, find the earliest next open day.

// Closed days: 0=Sunday, 1=Monday, ..., 6=Saturday
const closedDays = [1, 3, 5]; // Example: closed on Monday(1), Wednesday(3) and Friday(5)

// Format date + slot label
function formatDateTime(date, slot) {
    const d = date.toISOString().split("T")[0]; // yyyy-mm-dd
    return `${d} ${slot}`;
}

// Is this date open?
function isOpenDay(date) {
    return !closedDays.includes(date.getDay());
}

// Get the next open day starting from "date"
function getNextOpenDay(date) {
    let d = new Date(date);
    while (!isOpenDay(d)) {
        d.setDate(d.getDate() + 1);
    }
    return d;
}

function updatePickupTimes() {
    const select = document.getElementById('vbPickupTime');
    select.innerHTML = "";

    const now = new Date();
    // Myanmar time (UTC+6:30)
    const myanmarNow = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Yangon" }));
    const hour = myanmarNow.getHours();
    const minute = myanmarNow.getMinutes();
    const currentTime = hour + minute / 60;

    const today = new Date(myanmarNow);
    const tomorrow = new Date(myanmarNow);
    tomorrow.setDate(today.getDate() + 1);

    const times = [];

    // Check if today is open
    if (currentTime < 12 && isOpenDay(today)) {
        times.push({ text: `Today Evening (15:30 - 17:30)`, value: formatDateTime(today, "Evening") });
    }

    // Figure out tomorrow or next available open day
    const nextDay = getNextOpenDay(tomorrow);

    // Add tomorrow/next-day slots
    if (currentTime < 12) {
        times.push({ text: `${nextDay.toDateString()} Morning (11:00 - 13:00)`, value: formatDateTime(nextDay, "Morning") });
        times.push({ text: `${nextDay.toDateString()} Evening (15:30 - 17:30)`, value: formatDateTime(nextDay, "Evening") });
    } else {
        times.push({ text: `${nextDay.toDateString()} Morning (11:00 - 13:00)`, value: formatDateTime(nextDay, "Morning") });
        times.push({ text: `${nextDay.toDateString()} Evening (15:30 - 17:30)`, value: formatDateTime(nextDay, "Evening") });
    }

    // Populate the select box
    times.forEach(t => {
        const option = document.createElement("option");
        option.value = t.value;
        option.text = t.text;
        select.appendChild(option);
    });
}

// Run immediately
updatePickupTimes('viber');
</script>

<script>
// Remember some key fields between visits
const saveFields = [
    'vbName', 'vbAddress', 'vbYgnTwsp', 'vbPhone'
];

// Restore previous values
saveFields.forEach(id => {
    const el = document.getElementById(id);
    if (el && localStorage.getItem(id)) {
        el.value = localStorage.getItem(id);
    }

    // Save on input change
    if (el) {
        el.addEventListener('input', () => {
            localStorage.setItem(id, el.value);
        });
    }
});
</script>